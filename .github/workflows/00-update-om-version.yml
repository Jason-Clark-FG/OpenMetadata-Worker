name: "Worker: Step 0 - Update Latest Version"

on:
  workflow_dispatch:
  push:
    branches:
    - '**'
  schedule:
    - cron: '30 */2 * * *'

jobs:
  update_latest:
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MY_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          # Fetch latest release information
          RELEASE_DATA=$(curl -fSsL -X GET https://api.github.com/repos/open-metadata/OpenMetadata/releases/latest)
          LATEST_BRANCH=$(echo "${RELEASE_DATA}" | jq -r '.target_commitish')
          LATEST_TAG=$(echo "${RELEASE_DATA}" | jq -r '.tag_name')

          echo "LATEST_BRANCH: ${LATEST_BRANCH}"
          echo "LATEST_TAG: ${LATEST_TAG}"
          echo "Current OM_LATEST_RELEASE: ${{ vars.OM_LATEST_RELEASE }}"
          echo "Current LATEST_RELEASE_BRANCH: ${{ vars.LATEST_RELEASE_BRANCH }}"
          echo "Current LATEST_RELEASE_NAME: ${{ vars.LATEST_RELEASE_NAME }}"
          echo "Current LATEST_ES_RELEASE_BRANCH: ${{ vars.LATEST_ES_RELEASE_BRANCH }}"

          # Download the docker-compose.yml from the latest release
          COMPOSE_URL="https://github.com/open-metadata/OpenMetadata/releases/download/${LATEST_TAG}/docker-compose.yml"
          echo "Downloading compose file from: ${COMPOSE_URL}"
          COMPOSE_FILE=$(curl -fSsL "${COMPOSE_URL}")

          # Extract Elasticsearch version using yq
          LATEST_ES_VERSION=$(echo "${COMPOSE_FILE}" | yq '.services.elasticsearch.image | sub(".*:","")')
          echo "Detected Elasticsearch version: ${LATEST_ES_VERSION}"

          # Update OM_LATEST_RELEASE if changed
          if [[ ${LATEST_BRANCH} != ${{ vars.OM_LATEST_RELEASE }} ]];then
              echo "Updating OM_LATEST_RELEASE variable value to ${LATEST_BRANCH}"
              curl -fSsL -X PATCH -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ env.MY_TOKEN }}" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/variables/OM_LATEST_RELEASE -d "{\"name\":\"OM_LATEST_RELEASE\",\"value\":\"${LATEST_BRANCH}\"}"
          fi

          # Update LATEST_RELEASE_BRANCH if changed
          if [[ ${LATEST_BRANCH} != ${{ vars.LATEST_RELEASE_BRANCH }} ]];then
              echo "Updating LATEST_RELEASE_BRANCH variable value to ${LATEST_BRANCH}"
              curl -fSsL -X PATCH -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ env.MY_TOKEN }}" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/variables/LATEST_RELEASE_BRANCH -d "{\"name\":\"LATEST_RELEASE_BRANCH\",\"value\":\"${LATEST_BRANCH}\"}"
          fi

          # Update LATEST_RELEASE_NAME if changed
          if [[ ${LATEST_TAG} != ${{ vars.LATEST_RELEASE_NAME }} ]];then
              echo "Updating LATEST_RELEASE_NAME variable value to ${LATEST_TAG}"
              curl -fSsL -X PATCH -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ env.MY_TOKEN }}" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/variables/LATEST_RELEASE_NAME -d "{\"name\":\"LATEST_RELEASE_NAME\",\"value\":\"${LATEST_TAG}\"}"
          fi

          # Update LATEST_ES_RELEASE_BRANCH if changed
          if [[ ${LATEST_ES_VERSION} != ${{ vars.LATEST_ES_RELEASE_BRANCH }} ]];then
              echo "Updating LATEST_ES_RELEASE_BRANCH variable value to ${LATEST_ES_VERSION}"
              curl -fSsL -X PATCH -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ env.MY_TOKEN }}" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/variables/LATEST_ES_RELEASE_BRANCH -d "{\"name\":\"LATEST_ES_RELEASE_BRANCH\",\"value\":\"${LATEST_ES_VERSION}\"}"
          fi

